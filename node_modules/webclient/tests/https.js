'use strict';
var Curl = require('node-libcurl').Curl;

var opts = {
    headers: {
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'en-US,en;q=0.8',
        'Connection': 'keep-alive',
        'User-Agent': 'Mozilla/5.0 (Windows NT 6.4; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2225.0 Safari/537.36'
    }
};
// this works
// opts.url = 'https://www.yahoo.com';
// opts.proxy = 'socks5h://46.4.88.203:9050';

// this doesn't work. i get a timeout. on this proxy or any other http proxy
opts.url = 'https://www.yahoo.com';
opts.proxy = '220.255.3.170:80';

// this works
// opts.url = 'http://www.yahoo.com';
// opts.proxy = '220.255.3.170:80';

var curl = new Curl();
var curlOpts = {};
curlOpts['CUSTOMREQUEST'] = 'GET';
curlOpts['URL'] = opts.url;
curlOpts['CONNECTTIMEOUT_MS'] = 30000;
curlOpts['FOLLOWLOCATION'] = false;
curlOpts['ACCEPT_ENCODING'] = 'gzip';
curlOpts['PROXY'] = opts.proxy;
curlOpts['HTTPHEADER'] = [];
for (let key in opts.headers) {
    curlOpts['HTTPHEADER'].push(key + ': ' + opts.headers[key]);
}

for (let key in curlOpts) {
    curl.setOpt(Curl.option[key], curlOpts[key]);
}

curl.on('end', function (statusCode, body, headers) {
    console.log(statusCode, headers);
    curl.close();
});

curl.on('error', function(err, errCode) {
    console.error(err);
    curl.close();
});

curl.perform();
